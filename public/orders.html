<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WINK EXPRESS - Gestion des Commandes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <meta name="theme-color" content="#FF7F50">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/wink-icon-192x192.png">
  <meta name="apple-mobile-web-app-status-bar" content="#2C3E50">
  <style>
    :root {
      --clr-primary: #FF7F50;
      --clr-secondary: #2C3E50;
      --clr-accent: #4A6491;
      --clr-background: #F8F9FA;
      --clr-text: #34495E;
    }

    body {
      background-color: var(--clr-background);
      font-family: sans-serif;
      overflow-x: hidden;
      display: flex;
      min-height: 100vh;
    }

    /* --- Sidebar Styles --- */
    .sidebar {
      width: 250px;
      background-color: var(--clr-secondary);
      min-height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      color: white;
      padding: 20px;
      transition: transform 0.3s ease;
      z-index: 1050;
    }

    .sidebar-header {
      padding-bottom: 20px;
      border-bottom: 1px solid var(--clr-accent);
      margin-bottom: 20px;
    }

    .sidebar .nav-link {
      color: white;
      padding: 10px 15px;
      margin-bottom: 5px;
      border-radius: 5px;
      transition: background-color 0.2s;
    }

    .sidebar .nav-link:hover {
      background-color: var(--clr-accent);
    }

    .sidebar .nav-link.active {
      background-color: var(--clr-primary);
    }

    /* --- Main Content Styles --- */
    .main-content {
      margin-left: 250px;
      padding: 20px;
      flex-grow: 1;
      transition: margin-left 0.3s ease;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* --- Collapsed State for Mobile and Desktop Toggle --- */
    @media (max-width: 991.98px) {
      .sidebar {
        transform: translateX(-250px);
        left: 0;
        top: 0;
        height: 100vh;
      }
      .sidebar.show {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }

    /* Applied when toggler is used on desktop */
    @media (min-width: 992px) {
      .sidebar.collapsed {
        transform: translateX(-250px);
      }
      .main-content.expanded {
        margin-left: 0;
      }
    }

    /* --- Header Styles --- */
    .header {
      background-color: white;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .toggler {
      font-size: 1.5rem;
      color: var(--clr-secondary);
      cursor: pointer;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* --- Card & Table Styles --- */
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      border: none;
    }

    .table-responsive {
      flex-grow: 1;
      overflow-x: auto;
    }

    .table thead {
      background-color: var(--clr-secondary);
      color: white;
      font-size: 0.8rem;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .table th, .table td {
      vertical-align: middle;
      padding: 0.5rem;
      font-size: 0.85rem;
      white-space: nowrap;
      text-align: left;
    }

    .table .btn-sm {
      padding: 0.2rem 0.4rem;
      font-size: 0.7rem;
    }

    .table .dropdown-menu {
      min-width: 150px;
      font-size: 0.85rem;
    }

    /* Force la largeur des colonnes importantes */
    .col-checkbox { width: 30px; }
    .col-shop { width: 100px; }
    .col-client { width: 80px; }
    .col-location { width: 120px; }
    .col-product { width: 150px; }
    .col-amount-article { width: 80px; }
    .col-delivery-fee { width: 80px; }
    .col-payout { width: 80px; }
    .col-payment { width: 100px; }
    .col-status { width: 100px; }
    .col-deliveryman { width: 100px; }
    .col-actions { width: 80px; }

    /* Fixe l'alignement pour les montants */
    .table th.text-end, .table td.text-end { text-align: right !important; }


    /* --- Status/Payment Indicators --- */
    .status-container, .payment-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-container .bi, .payment-container .bi {
      font-size: 0.6rem;
    }
    
    /* Style commun pour les points indicateurs */
    .indicator-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }


    /* Couleurs Status */
    .status-pending { color: #ffc107; }
    .status-in_progress { color: #17a2b8; }
    .status-ready_for_pickup { color: var(--clr-accent); }
    .status-en_route { color: var(--clr-primary); }
    .status-delivered { color: #28a745; }
    .status-cancelled, .status-failed_delivery, .status-return_declared, .status-returned { color: #dc3545; } /* Retours et échecs en rouge */
    .status-reported { color: #6f42c1; }
    /* NOUVEAUX STATUTS */
    .status-Ne.decroche.pas, .status-Injoignable, .status-A.relancer, .status-Reportée { color: #6f42c1; }


    /* Couleurs Paiement */
    .payment-pending { color: #ffc107; }
    .payment-cash { color: #28a745; }
    .payment-paid_to_supplier { color: #17a2b8; }
    .payment-cancelled { color: #dc3545; }
    
    /* Appliquer les couleurs aux points via les classes status/payment */
    .status-container .status-pending, .payment-container .payment-pending { background-color: #ffc107; }
    .status-container .status-in_progress, .payment-container .payment-supplier_paid { background-color: #17a2b8; }
    .status-container .status-ready_for_pickup { background-color: var(--clr-accent); }
    .status-container .status-en_route { background-color: var(--clr-primary); }
    .status-container .status-delivered, .payment-container .payment-cash { background-color: #28a745; }
    /* CLÉ: Couleur unique pour tous les statuts d'échec/retour */
    .status-container .status-cancelled, 
    .status-container .status-failed_delivery, 
    .status-container .status-return_declared, 
    .status-container .status-returned, 
    .payment-container .payment-cancelled { background-color: #dc3545; }
    /* NOUVEAUX STATUTS (couleur violette de "reported") */
    .status-container .status-reported,
    .status-container .status-Ne.decroche.pas, 
    .status-container .status-Injoignable, 
    .status-container .status-A.relancer, 
    .status-container .status-Reportée { background-color: #6f42c1; }


    /* --- Buttons & Forms --- */
    .btn-primary-custom {
      background-color: var(--clr-primary);
      border-color: var(--clr-primary);
      color: white;
    }

    .btn-primary-custom:hover {
      background-color: #FF6347;
      border-color: #FF6347;
      color: white;
    }

    .filter-header-container {
      display: flex;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .filter-controls {
      display: flex;
      flex-grow: 1;
      gap: 10px;
      align-items: center;
    }
    
    /* Styles pour le bouton de tri par lieu (NOUVEAU) */
    #sortByLocationBtn {
      transition: background-color 0.2s, color 0.2s;
    }
    #sortByLocationBtn.active {
      background-color: var(--clr-accent);
      border-color: var(--clr-accent);
      color: white;
    }


    /* Pour les inputs de recherche/date pour une meilleure gestion responsive */
    .input-group-sm {
      max-width: 250px;
      flex-grow: 1;
    }

    .input-group-text {
      font-size: 0.8rem;
    }

    .search-container {
      position: relative;
    }

    .search-results {
      position: absolute;
      z-index: 10;
      width: 100%;
      background: white;
      border: 1px solid #ced4da;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .search-results div {
      padding: 8px 12px;
      cursor: pointer;
    }
    .search-results div:hover {
      background-color: #f0f0f0;
    }

    /* Modals for Adding/Editing Orders */
    .modal-dialog-scrollable .modal-body {
      max-height: 70vh;
    }

    .item-row {
      align-items: flex-end;
    }
    .remove-item-btn {
      background: none;
      border: none;
      color: #dc3545;
      font-size: 1.25rem;
      cursor: pointer;
      margin-left: 5px;
      padding: 0;
      line-height: 1;
    }

    /* Notification Toast Style */
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      width: 350px;
      max-width: 90%;
    }

    /* --- NOUVEAU STYLE POUR L'INDICATEUR DE SÉLECTION --- */
    .selected-count-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      font-weight: bold;
      color: var(--clr-primary);
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
      cursor: default;
    }
    .selected-count-dot {
      width: 10px;
      height: 10px;
      background-color: var(--clr-primary);
      border-radius: 50%;
      display: inline-block;
    }
    .selected-count-number {
      min-width: 2ch;
      text-align: right;
    }


    /* Responsive adjustments */
    @media (max-width: 767.98px) {
      .filter-header-container {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-controls > div, .filter-controls .input-group-sm, .dropdown.status-dropdown-container, .selected-count-indicator, #sortByLocationBtn {
        max-width: 100%;
        width: 100%;
        margin-left: 0 !important;
        margin-bottom: 5px;
        justify-content: center;
      }
      .table-responsive table {
        min-width: 1200px;
      }
      .header-actions {
        margin-top: 10px;
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>

  <aside class="sidebar" id="sidebar">
    <header class="sidebar-header d-flex justify-content-center">
      <img src="wink-logo.png" alt="Logo WINK EXPRESS" style="width: 150px;">
    </header>

    <nav class="nav flex-column">
      <a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Tableau de bord</a>
      <a class="nav-link active" href="orders.html"><i class="bi bi-box-seam me-2"></i> Commandes</a>
      <a class="nav-link" href="preparation.html"><i class="bi bi-box-arrow-in-up me-2"></i> Préparation Colis</a>
      <a class="nav-link" href="deliverymen.html"><i class="bi bi-bicycle me-2"></i> Livreurs</a>
      <a class="nav-link" href="shops.html"><i class="bi bi-shop me-2"></i> Marchands</a>
      <a class="nav-link" href="reports.html"><i class="bi bi-file-earmark-bar-graph me-2"></i> Rapports</a>
      
      <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="remittancesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-wallet me-2"></i> Versements
          </a>
          <ul class="dropdown-menu" aria-labelledby="remittancesDropdown">
              <li><a class="dropdown-item" href="remittances.html">Versements en attente</a></li>
              <li><a class="dropdown-item" href="debts.html">Créances</a></li>
              <li><a class="dropdown-item" href="cash.html">Caisse</a></li>
          </ul>
      </div>
      
      <a class="nav-link" href="suivis.html">
        <i class="bi bi-chat-dots me-2"></i> Suivis
        <span class="badge bg-danger ms-auto d-none" id="global-unread-badge">0</span>
      </a>

      <a class="nav-link" href="users.html"><i class="bi bi-person me-2"></i> Utilisateurs</a>
    </nav>
  </aside>

  <main class="main-content" id="main-content">
    <header class="header">
      <i class="bi bi-list toggler" id="sidebar-toggler"></i>
      <h1 class="h4 mb-0 ms-3 flex-grow-1">Gestion des Commandes</h1>
      <div class="header-actions">
        <button class="btn btn-sm btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addOrderModal">
          <i class="bi bi-plus-circle me-1"></i> Ajouter une commande
        </button>
        <div class="dropdown">
          <a href="#" class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="https://ui-avatars.com/api/?name=A&size=32&background=2C3E50&color=fff&rounded=true" alt="Avatar" width="32" height="32" class="rounded-circle me-2">
            <span id="userName">{{username}}</span>
          </a>
          <ul class="dropdown-menu text-small shadow">
            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i> Profil</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i> Déconnexion</a></li>
          </ul>
        </div>
      </div>
    </header>

    <div id="notification-container"></div>

    <section class="filter-header-container">
        <div class="filter-controls">
            <div class="input-group input-group-sm">
                <label for="searchInput" class="input-group-text"><i class="bi bi-search"></i></label>
                <input type="text" class="form-control" placeholder="Commande, client..." id="searchInput">
            </div>
            <div class="input-group input-group-sm">
                <label for="startDateFilter" class="input-group-text">Du</label>
                <input type="date" class="form-control" id="startDateFilter">
            </div>
            <div class="input-group input-group-sm">
                <label for="endDateFilter" class="input-group-text">Au</label>
                <input type="date" class="form-control" id="endDateFilter">
            </div>
            <div class="dropdown status-dropdown-container">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="statusFilterBtn">
                    Statut : Tous
                </button>
                <ul class="dropdown-menu w-100" id="statusFilterMenu">
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="">Tous</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="pending">En attente</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="in_progress">Assignée</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="ready_for_pickup">Prête</a></li> 
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="en_route">En route</a></li> 
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="delivered">Livrée</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="cancelled">Annulée</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="failed_delivery">Livraison ratée</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="return_declared">Retour déclaré</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="Ne decroche pas">Ne décroche pas</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="Injoignable">Injoignable</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="A relancer">À relancer</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="Reportée">Reportée</a></li>
                    <li><a class="dropdown-item status-filter-option" href="#" data-status="returned">Retournée</a></li>
                </ul>
            </div>
            
            <button id="sortByLocationBtn" class="btn btn-sm btn-outline-secondary" title="Trier les commandes en attente par lieu" type="button">
                 <i class="bi bi-geo-alt"></i> Trier
            </button>
            
            <span class="selected-count-indicator ms-2" id="selectedOrdersIds" data-bs-toggle="tooltip" title="Aucune commande sélectionnée">
                <span class="selected-count-dot"></span>
                <span class="selected-count-number">00</span>
            </span>
        </div>
        <div class="d-flex align-items-end gap-2">
            <button class="btn btn-sm btn-secondary" id="filterBtn"><i class="bi bi-funnel me-1"></i> Filtrer</button>
            <div class="dropdown" id="bulkActionsDropdown">
                <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions groupées
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item bulk-assign-btn" href="#"><i class="bi bi-person me-2"></i> Attribuer un livreur</a></li>
                    
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item bulk-status-delivered-btn" href="#" data-bs-toggle="modal" data-bs-target="#bulkStatusActionModal"><i class="bi bi-check-circle me-2"></i> Statuer Livrée</a></li>
                    <li><a class="dropdown-item bulk-status-failed-btn" href="#" data-bs-toggle="modal" data-bs-target="#bulkFailedDeliveryModal"><i class="bi bi-x-circle me-2"></i> Statuer Livraison ratée</a></li>
                    <li><a class="dropdown-item bulk-status-cancel-btn" href="#"><i class="bi bi-slash-circle me-2"></i> Annuler</a></li>
                    
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item bulk-status-no-answer-btn" href="#"><i class="bi bi-telephone-x me-2"></i> Ne décroche pas</a></li>
                    <li><a class="dropdown-item bulk-status-unreachable-btn" href="#"><i class="bi bi-person-x me-2"></i> Injoignable</a></li>
                    <li><a class="dropdown-item bulk-status-relaunch-btn" href="#"><i class="bi bi-arrow-clockwise me-2"></i> À relancer</a></li>
                    <li><a class="dropdown-item bulk-status-report-btn" href="#"><i class="bi bi-calendar-plus me-2"></i> Reporter</a></li>
                    
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item bulk-delete-btn text-danger" href="#"><i class="bi bi-trash me-2"></i> Supprimer</a></li>
                </ul>
            </div>
        </div>
    </section>

    <section class="card p-4">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="col-checkbox"><input type="checkbox" id="selectAllCheckbox"></th>
                        <th class="col-shop">Marchand</th>
                        <th class="col-client">Client</th>
                        <th class="col-location">Lieu</th>
                        <th class="col-product">Produit</th>
                        <th class="col-amount-article text-end">Montant article</th>
                        <th class="col-delivery-fee text-end">Frais liv.</th>
                        <th class="col-payout text-end">Montant à verser</th>
                        <th class="col-payment">Paiement</th>
                        <th class="col-status">Statut</th>
                        <th class="col-deliveryman">Livreur</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    </tbody>
            </table>
        </div>

        <footer class="d-flex justify-content-between align-items-center mt-3">
            <div class="d-flex align-items-center gap-2">
                <label for="itemsPerPage" class="form-label mb-0 me-2 text-nowrap small">Lignes par page:</label>
                <select class="form-select form-select-sm w-auto" id="itemsPerPage">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="d-flex align-items-center">
                <span id="paginationInfo" class="me-3 small text-muted"></span>
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" id="firstPage"><a class="page-link" href="#"><i class="bi bi-skip-start-fill"></i></a></li>
                        <li class="page-item" id="prevPage"><a class="page-link" href="#"><i class="bi bi-caret-left-fill"></i></a></li>
                        <li class="page-item disabled"><span class="page-link" id="currentPageDisplay">1</span></li>
                        <li class="page-item" id="nextPage"><a class="page-link" href="#"><i class="bi bi-caret-right-fill"></i></a></li>
                        <li class="page-item" id="lastPage"><a class="page-link" href="#"><i class="bi bi-skip-end-fill"></i></a></li>
                    </ul>
                </nav>
            </div>
        </footer>
    </section>
  </main>

  <div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" style="max-width: 700px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addOrderModalLabel">Ajouter une nouvelle commande</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="addOrderForm">
          <div class="modal-body">
            <div class="mb-2">
                <label for="shopSearchInput" class="form-label mb-1">Marchand</label>
                <div class="input-group">
                    <input type="text" class="form-control form-control-sm" id="shopSearchInput" placeholder="Rechercher un marchand" required>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#addShopModal"><i class="bi bi-plus"></i></button>
                </div>
                <div id="searchResults" class="search-results d-none"></div>
                <input type="hidden" id="selectedShopId">
            </div>
            <div class="row g-2">
                <div class="col-md-6 mb-2">
                    <label for="customerName" class="form-label mb-1">Nom du client</label>
                    <input type="text" class="form-control form-control-sm" id="customerName">
                </div>
                <div class="col-md-6 mb-2">
                    <label for="customerPhone" class="form-label mb-1">Numéro de tél. du client</label>
                    <input type="tel" class="form-control form-control-sm" id="customerPhone" placeholder="Ex: 650724683" required>
                </div>
            </div>
            <div class="mb-2">
                <label for="deliveryLocation" class="form-label mb-1">Lieu de livraison</label>
                <input type="text" class="form-control form-control-sm" id="deliveryLocation" placeholder="Ex: Bastos" required>
            </div>

            <hr class="my-3">

            <h6 class="d-flex justify-content-between align-items-center mb-2">
                Articles
                <button type="button" class="btn btn-secondary btn-sm" id="addItemBtn">
                    <i class="bi bi-plus-circle"></i> Ajouter
                </button>
            </h6>
            <div id="itemsContainer">
                </div>

            <hr class="my-3">

            <div class="mb-2 form-check">
                <input class="form-check-input" type="checkbox" id="isExpedition">
                <label class="form-check-label" for="isExpedition">C'est une expédition</label>
            </div>

            <div id="expeditionFeeContainer" class="mb-2" style="display: none;">
                <label for="expeditionFee" class="form-label mb-1">Frais d'expédition</label>
                <input type="number" class="form-control form-control-sm" id="expeditionFee" value="0">
            </div>

            <div class="mb-2">
                <label for="deliveryFee" class="form-label mb-1">Frais de livraison</label>
                <input type="number" class="form-control form-control-sm" id="deliveryFee" value="0" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary-custom">Ajouter une nouvelle commande</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addShopModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="addShopModalLabel">Ajouter un nouveau marchand</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="addShopForm">
                <div class="modal-body">
                    <div class="mb-3"><label for="newShopName" class="form-label">Nom du marchand</label><input type="text" class="form-control" id="newShopName" required></div>
                    <div class="mb-3"><label for="newShopPhone" class="form-label">Numéro de téléphone</label><input type="tel" class="form-control" id="newShopPhone" required></div>
                    <hr>
                    <p class="fw-bold mb-2">Options de Facturation</p>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" role="switch" id="newBillPackaging"><label class="form-check-label" for="newBillPackaging">Activer la facturation des emballages</label>
                    </div>
                    <div class="input-group input-group-sm mb-3">
                        <span class="input-group-text">Prix</span>
                        <input type="number" class="form-control" id="newPackagingPrice" value="50" min="0">
                        <span class="input-group-text">FCFA</span>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" role="switch" id="newBillStorage"><label class="form-check-label" for="newBillStorage">Activer la facturation du stockage</label>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">Prix</span>
                        <input type="number" class="form-control" id="newStoragePrice" value="100" min="0">
                         <span class="input-group-text">FCFA / jour</span>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button type="submit" class="btn btn-primary-custom" id="newShopSubmitBtn">Ajouter</button></div>
            </form>
        </div>
    </div>
  </div>

  <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" style="max-width: 700px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editOrderModalLabel">Modifier la commande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editOrderForm">
                <input type="hidden" id="editDeliverymanId"> 
                <div class="modal-body">
                    <input type="hidden" id="editOrderId">
                    <div class="mb-2">
                        <label for="editShopSearchInput" class="form-label mb-1">Marchand</label>
                        <div class="search-container">
                            <input type="text" class="form-control form-control-sm" id="editShopSearchInput" placeholder="Rechercher un marchand" required>
                            <div id="editSearchResults" class="search-results d-none"></div>
                            <input type="hidden" id="editSelectedShopId">
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label for="editCustomerName" class="form-label mb-1">Nom du client</label>
                            <input type="text" class="form-control form-control-sm" id="editCustomerName">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="editCustomerPhone" class="form-label mb-1">Numéro de tél. du client</label>
                            <input type="tel" class="form-control form-control-sm" id="editCustomerPhone" placeholder="Ex: 690 48 49 89" required>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="editDeliveryLocation" class="form-label mb-1">Lieu de livraison</label>
                        <input type="text" class="form-control form-control-sm" id="editDeliveryLocation" placeholder="Ex: Bastos" required>
                    </div>

                    <div class="mb-2">
                        <label for="editCreatedAt" class="form-label mb-1">Date et heure de la commande</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="editCreatedAt" required>
                    </div>

                    <hr class="my-3">

                    <h6 class="d-flex justify-content-between align-items-center mb-2">
                        Articles
                        <button type="button" class="btn btn-secondary btn-sm" id="editAddItemBtn">
                            <i class="bi bi-plus-circle"></i> Ajouter
                        </button>
                    </h6>
                    <div id="editItemsContainer">
                        </div>

                    <hr class="my-3">

                    <div class="mb-2 form-check">
                        <input class="form-check-input" type="checkbox" id="editIsExpedition">
                        <label class="form-check-label" for="editIsExpedition">C'est une expédition</label>
                    </div>

                    <div id="editExpeditionFeeContainer" class="mb-2" style="display: none;">
                        <label for="editExpeditionFee" class="form-label mb-1">Frais d'expédition</label>
                        <input type="number" class="form-control form-control-sm" id="editExpeditionFee" value="0">
                    </div>

                    <div class="mb-2">
                        <label for="editDeliveryFee" class="form-label mb-1">Frais de livraison</label>
                        <input type="number" class="form-control form-control-sm" id="editDeliveryFee" value="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">Enregistrer les modifications</button>
                </div>
            </form>
        </div>
    </div>
  </div>

  <div class="modal fade" id="statusActionModal" tabindex="-1" aria-labelledby="statusActionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="statusActionModalLabel">Modifier le statut</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <div id="deliveredPaymentForm" class="d-none">
                      <p>Sélectionnez le mode de paiement :</p>
                      <div class="d-flex gap-2">
                          <button type="button" class="btn btn-success flex-grow-1" id="paymentCashBtn"><i class="bi bi-cash me-2"></i>Cash</button>
                          <button type="button" class="btn btn-info flex-grow-1" id="paymentSupplierBtn"><i class="bi bi-phone me-2"></i>Mobile Money</button>
                      </div>
                  </div>
                  <form id="failedDeliveryForm" class="d-none">
                      <div class="mb-3">
                          <label for="amountReceived" class="form-label">Montant reçu du client (si paiement partiel)</label>
                          <input type="number" class="form-control" id="amountReceived" value="0" placeholder="0">
                      </div>
                      <button type="submit" class="btn btn-primary-custom">Confirmer</button>
                  </form>
              </div>
          </div>
      </div>
  </div>

  <div class="modal fade" id="assignDeliveryModal" tabindex="-1" aria-labelledby="assignDeliveryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-md">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="assignDeliveryModalLabel">Assigner un livreur</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="assignDeliveryForm">
                  <div class="modal-body">
                       <div class="mb-3">
                          <label for="deliverymanSearchInput" class="form-label">Rechercher un livreur</label>
                          <div class="search-container">
                              <input type="text" class="form-control" id="deliverymanSearchInput" placeholder="Nom du livreur...">
                              <div id="deliverymanSearchResults" class="search-results d-none"></div>
                          </div>
                          <input type="hidden" id="assignDeliverymanId">
                      </div>
                      <hr>
                      <h6>Commandes sélectionnées</h6>
                      <p class="text-muted small">ID des commandes : <span id="selectedOrdersIdsModalInfo">Aucune</span></p>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                      <button type="submit" class="btn btn-primary-custom"><i class="bi bi-person-check me-2"></i>Assigner</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <div class="modal fade" id="bulkStatusActionModal" tabindex="-1" aria-labelledby="bulkStatusActionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="bulkStatusActionModalLabel">Statuer Livrée (Groupé)</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <p>Sélectionnez le mode de paiement pour les commandes livrées :</p>
                  <div id="bulkDeliveredPaymentForm">
                      <div class="d-flex gap-2">
                          <button type="button" class="btn btn-success flex-grow-1" id="bulkPaymentCashBtn"><i class="bi bi-cash me-2"></i>Cash</button>
                          <button type="button" class="btn btn-info flex-grow-1" id="bulkPaymentSupplierBtn"><i class="bi bi-phone me-2"></i>Mobile Money</button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="modal fade" id="bulkFailedDeliveryModal" tabindex="-1" aria-labelledby="bulkFailedDeliveryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="bulkFailedDeliveryModalLabel">Statuer comme "Livraison ratée" (Groupé)</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="bulkFailedDeliveryForm">
                  <div class="modal-body">
                      <div class="mb-3">
                          <label for="bulkAmountReceived" class="form-label">Montant reçu des clients (si paiement partiel)</label>
                          <input type="number" class="form-control" id="bulkAmountReceived" value="0" placeholder="0">
                      </div>
                      <button type="submit" class="btn btn-primary-custom">Confirmer</button>
                  </div>
              </form>
          </div>
      </div>
  </div>
  
  <div class="modal fade" id="scheduleFollowUpModal" tabindex="-1" aria-labelledby="scheduleFollowUpModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="scheduleFollowUpModalLabel">Planifier une action</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form id="scheduleFollowUpForm">
                  <div class="modal-body">
                      <input type="hidden" id="scheduleOrderIds">
                      <input type="hidden" id="scheduleNewStatus">
                      <p>Définir la date et l'heure de suivi pour : <strong id="scheduleOrderInfo"></strong></p>
                      <div class="mb-3">
                          <label for="followUpDate" class="form-label">Date de suivi</label>
                          <input type="date" class="form-control" id="followUpDate" required>
                      </div>
                      <div class="mb-3">
                          <label for="followUpTime" class="form-label">Heure de suivi</label>
                          <input type="time" class="form-control" id="followUpTime" required>
                      </div>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                      <button type="submit" class="btn btn-primary-custom">Confirmer la planification</button>
                  </div>
              </form>
          </div>
      </div>
  </div>
  
  <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="orderDetailsModalLabel">Détails de la commande</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <div id="orderDetailsContent">
                      </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
              </div>
          </div>
      </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script> 
  <script src="js/auth.js"></script>
  <script src="js/orders.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
  <script src="/js/pwa-loader.js" defer></script>
</body>
</html>